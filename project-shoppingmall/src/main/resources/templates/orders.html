<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>주문 결제 페이지</title>
<link rel="stylesheet" type="text/css" href="/css/orders/orders.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- 포트원 결제 -->
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<!-- iamport.payment.js -->
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>

	<!-- 상품 정보를 숨겨진 필드로 설정 -->
	<input type="hidden" id="productName"
		th:value="${productvo != null ? productvo.product_name : ''}" />
	<input type="hidden" id="productPrice"
		th:value="${productvo != null ? productvo.product_price : ''}" />
	<!-- 카트 총 상품 금액 숨겨진 필드로 설정 -->
	<input type="hidden" id="cartPrices"
		th:value="${cartvo != null ? cartvo.cartPrice : ''}" />
	<input type="hidden" id="totalCartPrice" th:value="${totalCartPrice}" />
	<!-- 사용자 정보 숨겨진 필드로 설정-->
	<input type="hidden" id="userName"
		th:value="${uservo != null ? uservo.name : ''}" />
	<input type="hidden" id="userPhone"
		th:value="${uservo != null ? uservo.phone : ''}" />
	<input type="hidden" id="userAddress"
		th:value="${uservo != null ? uservo.address : ''}" />
	<input type="hidden" id="userPostcode"
		th:value="${uservo != null ? uservo.postcode : ''}" />
	<input type="hidden" id="userEmail"
		th:value="${uservo != null ? uservo.email : ''}" />

	<!-- 주문서 컨테이너 시작 *********************************** -->
	<div class="container">
		<h1>주문/결제</h1>
		<div class="navigation">
			쇼핑백 > <span style="color: black;">주문결제</span> > 주문완료
		</div>

		<h3>배송지 정보</h3>
		<div class="section">
			<form th:action="@{/createOrder}" method="post">
				<input type="hidden" id="totalCartPrice"
					th:value="${totalCartPrice}" />
				<p>
					이름: <span th:text="${uservo != null ? uservo.name : '정보 없음'}"></span>
					우편번호: <span th:text="${uservo != null ? uservo.postcode : '정보 없음'}"></span>
					주소: <span th:text="${uservo != null ? uservo.address : '정보 없음'}"></span>
					상세주소: <span
						th:text="${uservo != null ? uservo.address_detail : '정보 없음'}"></span>
					전화번호: <span th:text="${uservo != null ? uservo.phone : '정보 없음'}"></span>
				</p>
				<p>
					배송 요청사항: <select id="ordermemo" name="ordermemo"
						onchange="showInputField(this)">
						<option value="">배송 요청 사항을 선택해 주세요.</option>
						<option value="1">부재 시 경비실에 맡겨주세요.</option>
						<option value="2">부재 시 전화 또는 문자 주세요.</option>
						<option value="3">배송 전 연락주세요.</option>
						<option value="4">택배함에 넣어주세요.</option>
						<option value="5">파손위험 상품.배송 주의해주세요.</option>
						<option value="6">직접입력</option>
					</select> <input type="text" id="customOrderMemo" name="customOrderMemo"
						placeholder="내용을 입력해주세요. (20자 이내)" maxlength="20"
						style="display: none;">
				</p>
				<hr>
			</form>
		</div>

		<h3>주문 상품 목록</h3>
		<div class="section">
			<form th:action="@{/shoping-cart.html}" method="get">
				<table>
					<thead>
						<tr>
							<th>상품정보</th>
							<th>옵션</th>
							<th>수량</th>
							<th>가격</th>
							<th>총 상품 금액</th>
							<th>배송비</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="item, iterStat : ${cartItems}">
							<td th:text="${item != null ? item.productName : ''}"></td>
							<td th:text="${item != null ? item.productOption : ''}"></td>
							<td th:text="${cartCount[iterStat.index]}"></td>
							<td
								th:text="${item != null && item.productPrice != null ? #numbers.formatCurrency(item.productPrice) : ''}"></td>
							<td
								th:text="${(item.productPrice != null && cartCount[iterStat.index] != null) ? #numbers.formatCurrency(item.productPrice * cartCount[iterStat.index]) : '0원'}"></td>
							<!-- 수정된 부분 -->
							<td>무료배송</td>
						</tr>
					</tbody>
				</table>
			</form>
			<hr>
			<p class="small-text">* 제주/도서산간 지역의 경우 추가 배송비가 발생할 수 있습니다.</p>
		</div>

		<h3>할인</h3>
		<div class="section">
			<p>
				쿠폰 적용: <input type="text" id="couponCode"
					placeholder="쿠폰 코드를 입력하세요.">
			</p>
			<p>
				적용된 할인 금액: <span id="discountAmount">0원</span>
			</p>
			<hr>
		</div>

		<h3>결제수단</h3>
		<div class="section">
			<p>
				<input type="radio" id="card" name="paymentMethod" value="card"
					checked> <label for="card">신용카드</label>
			</p>
			<p>
				<input type="radio" id="bank" name="paymentMethod" value="bank">
				<label for="bank">무통장 입금</label>
			</p>
			<p>
				<input type="radio" id="kakaopay" name="paymentMethod"
					value="kakaopay"> <label for="kakaopay">카카오페이</label>
			</p>
			<hr>
		</div>
		<button id="paymentButton" onclick="requestPayment()">결제하기</button>
	</div>

	<script>
		function showInputField(select) {
			const inputField = document.getElementById('customOrderMemo');
			inputField.style.display = select.value === "6" ? 'block' : 'none';
		}

		// 결제하기 api 구현
		function requestPayment() {
			// Iamport 결제 API 초기화
			IMP.init('imp13623334'); 

			const totalAmount = document.getElementById('totalCartPrice').value;
			const productName = document.getElementById('productName').value;
			const name = document.getElementById("userName").value;
			const phone = document.getElementById("userPhone").value;
			const address = document.getElementById("userAddress").value;
			const postcode = document.getElementById("userPostcode").value;
			const email = document.getElementById("userEmail").value;

			console.log("결제 요청 데이터:", {
				productName : productName,
				name : name,
				phone : phone,
				address : address,
				postcode : postcode,
				email : email,
				totalAmount : totalAmount,
				merchant_uid : `mid_${new Date().getTime()}`
			});

			// 결제 API 호출
			IMP.request_pay({
				pg : 'nice_v2', // 결제할 PG사
				pay_method : 'card', // 결제 방법 (카드)
				merchant_uid : `mid_${new Date().getTime()}`, // 고유 주문 ID
				name : productName, // 상품명
				amount : totalAmount, // 결제 금액
				buyer_name : name, // 구매자 이름
				buyer_tel : phone, // 구매자 전화번호
				buyer_addr : address, // 구매자 주소
				buyer_postcode : postcode, // 구매자 우편번호
				buyer_email : email, // 구매자 이메일
			}, function(response) {
				console.log("결제 응답:", response);
				if (response.success) {
					alert("결제 완료! 고유번호: " + response.imp_uid);
					window.location.href = 'orderComplete.html'; // 결제 완료 후 이동할 페이지
				} else {
					alert("결제 실패: " + response.error_msg); // 결제 실패 시 오류 메시지
				}
			});
		}
	</script>
</body>
</html>